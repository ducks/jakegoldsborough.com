<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="fediverse:creator" content="@ducks@hachyderm.io">
    <link rel="me" href="https://hachyderm.io/@ducks" />
    <meta name="author" content="Jake Goldsborough">

    <link rel="preload" href="https://jakegoldsborough.com/fonts/berkeley-mono/BerkeleyMono-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="https://jakegoldsborough.com/fonts/waika/waika-webfont.woff2" as="font" type="font/woff2" crossorigin>
    
    <meta name="description" content="Uncovering a deeper architectural issue in the AWS Ruby SDK where credential chain precedence prevented role assumption from working correctly with environment variable source credentials.">
    <meta name="keywords" content="NixOS, Linux, Rust, self-hosting, programming, tech blog, OSS">

    
    <meta property="og:site_name" content="Jake Goldsborough">
    <meta property="og:title" content="Going off the Rails on the AWS Credential Chain">
    <meta property="og:description" content="Uncovering a deeper architectural issue in the AWS Ruby SDK where credential chain precedence prevented role assumption from working correctly with environment variable source credentials.">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https:&#x2F;&#x2F;jakegoldsborough.com&#x2F;blog&#x2F;2025&#x2F;contributing-to-aws-sdk-ruby-pt2&#x2F;">

    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Going off the Rails on the AWS Credential Chain">
    <meta name="twitter:description" content="Uncovering a deeper architectural issue in the AWS Ruby SDK where credential chain precedence prevented role assumption from working correctly with environment variable source credentials.">

    <title>Going off the Rails on the AWS Credential Chain - Jake Goldsborough</title>

    <link rel="stylesheet" href="https://jakegoldsborough.com/css/style.css" />

    
    <link rel="icon" href="https://jakegoldsborough.com/images/favicon.png" />
  </head>
  <body>
    <header>
      
        <h1><a href="https://jakegoldsborough.com">Jake Goldsborough</a></h1>
      

      <input type="checkbox" id="menu-toggle" class="menu-toggle" />
      <label for="menu-toggle" class="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </label>

      <nav>
        <a
          href="https://jakegoldsborough.com/blog"
          class="active"
        >Blog</a>
        <a
          href="https://jakegoldsborough.com/resume"
          class=""
          >Resume</a>
        <a
          href="https://jakegoldsborough.com/projects"
          class=""
          >Projects</a>
        <a
          href="https://jakegoldsborough.com/contact"
          class=""
          >Contact</a>
      </nav>
    </header>
    <main>
      
  
    <article>
      <h1>Going off the Rails on the AWS Credential Chain</h1>
      <div class="meta">
        
        <p>Oct 04, 2025</p>
        
        <p>4 min read</p>
      </div>

      
        <div class="tags">
          
          <p><a href="/tags/aws">#aws</a></p>
          
          <p><a href="/tags/ruby">#ruby</a></p>
          
          <p><a href="/tags/oss">#oss</a></p>
          
        </div>
      

      <h3 id="the-plot-twist">The Plot Twist</h3>
<p>Remember that <a href="/blog/2025/contributing-to-aws-sdk-ruby/">AWS SDK
contribution</a>
I wrote about? The one where I fixed missing <code>credential_source = Environment</code>
support? Well, turns out that was only half the story.</p>
<p>After my PR got merged and we updated our Discourse deployment to <code>aws-sdk-core 3.233.0</code>, I was excited to finally see role assumption working. The missing
credential source was fixed, our config looked perfect, and all the unit tests
were passing.</p>
<p>But when I deployed it to our test cluster, I still got an error. It was a new
error, but an error nonetheless. Instead of <code>UnsupportedCredentialType</code>, I was
now getting a permission denied error when trying to use AWS S3 operations.</p>
<h3 id="the-real-problem">The Real Problem</h3>
<p>Here's what was happening. I'd check the identity in our Rails console:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span>discourse(prod)&gt; sts = </span><span style="color:#ebcb8b;">Aws</span><span>::</span><span style="color:#ebcb8b;">STS</span><span>::</span><span style="color:#ebcb8b;">Client</span><span>.</span><span style="color:#8fa1b3;">new
</span><span>discourse(prod)&gt; </span><span style="color:#96b5b4;">puts</span><span> sts.get_caller_identity.arn
</span><span style="color:#a3be8c;">arn:aws:</span><span>iam::</span><span style="color:#d08770;">123456789012</span><span style="color:#a3be8c;">:user</span><span>/</span><span style="color:#bf616a;">MyUser
</span></code></pre>
<p>That should have been showing an assumed role ARN like:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>arn:aws:iam::123456789012:assumed-role/MyRole/session-name
</span></code></pre>
<p>The SDK was still using environment variables directly instead of using them as
source credentials to assume the configured role.</p>
<h3 id="the-investigation-round-2">The Investigation (Round 2)</h3>
<p>Back to the AWS SDK source code, this time looking at
<code>credential_provider_chain.rb</code>. And there it was - a classic ordering problem:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">providers
</span><span>[
</span><span style="color:#65737e;"># ... other providers ...
</span><span>[</span><span style="color:#a3be8c;">:env_credentials</span><span>, {}], </span><span style="color:#65737e;"># Position 7 ← Wins!
</span><span style="color:#65737e;"># ... other providers ...
</span><span>[</span><span style="color:#a3be8c;">:assume_role_credentials</span><span>, {}], </span><span style="color:#65737e;"># Position 10 ← Never reached
</span><span>]
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>The credential chain finds <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> in
position 7, returns those credentials immediately, and never reaches the role
assumption logic at position 10.</p>
<p>But here's the thing - this isn't as simple as just moving
<code>assume_role_credentials</code> higher in the chain. That might break existing
behavior for thousands of applications that rely on direct environment variable
usage.</p>
<h3 id="the-real-architecture-problem">The Real Architecture Problem</h3>
<p>What should happen with this config:</p>
<pre data-lang="ini" style="background-color:#2b303b;color:#c0c5ce;" class="language-ini "><code class="language-ini" data-lang="ini"><span style="color:#b48ead;">[default]
</span><span style="color:#bf616a;">role_arn </span><span>= arn:aws:iam::</span><span style="color:#d08770;">123456789012</span><span>:role/MyRole
</span><span style="color:#bf616a;">credential_source </span><span>= Environment
</span><span style="color:#bf616a;">role_session_name </span><span>= test-session
</span><span style="color:#bf616a;">region </span><span>= us-west-</span><span style="color:#d08770;">2
</span></code></pre>
<p><strong>Expected flow:</strong></p>
<ol>
<li>SDK sees <code>role_arn</code> + <code>credential_source = Environment</code></li>
<li>SDK uses <code>AWS_ACCESS_KEY_ID</code>/<code>AWS_SECRET_ACCESS_KEY</code> as <strong>source credentials</strong></li>
<li>SDK calls <code>AssumeRole</code> with those source credentials</li>
<li>SDK returns <strong>assumed role credentials</strong></li>
</ol>
<p><strong>Actual flow:</strong></p>
<ol>
<li>SDK finds <code>AWS_ACCESS_KEY_ID</code>/<code>AWS_SECRET_ACCESS_KEY</code> in environment</li>
<li>SDK returns those credentials directly (chain stops)</li>
<li>Role assumption config is never processed</li>
</ol>
<h3 id="the-contribution">The Contribution</h3>
<p>I filed <a href="https://github.com/aws/aws-sdk-ruby/issues/3301">Bug #3301</a> with:</p>
<ul>
<li>Clear reproduction steps</li>
<li>Root cause analysis pointing to the specific code location</li>
<li>Expected vs. actual behavior with ARN examples</li>
<li>A workaround using <code>source_profile</code> (though it requires plaintext keys)</li>
</ul>
<h3 id="the-response">The Response</h3>
<p>The AWS team's response was exactly what you hope for:</p>
<blockquote>
<p>"Hey, thanks for opening an issue. I believe you are correct and this is
something we need to fix. I need to confirm some details regarding
AssumeRoleCredentials profile chaining with the team first and I'll keep you
updated."</p>
</blockquote>
<p>That's maintainer validation that this is a real architectural issue, not user
error.</p>
<h3 id="what-i-learned-again">What I Learned (Again)</h3>
<p><strong>Complex systems have complex bugs:</strong> My first fix solved the missing feature,
but revealed a deeper architectural problem with credential chain precedence.</p>
<p><strong>Sometimes the obvious fix isn't right:</strong> Moving <code>assume_role_credentials</code>
higher might seem simple, but it requires careful consideration of context and
backward compatibility.</p>
<p><strong>Good bug reports matter:</strong> Clear reproduction steps, root cause analysis, and
concrete examples help maintainers understand and prioritize issues.</p>
<p><strong>Persistence pays off:</strong> I could have stopped after the first fix and lived
with workarounds. But pushing deeper led to identifying a more fundamental
issue.</p>
<h3 id="the-bigger-picture">The Bigger Picture</h3>
<p>This experience reinforced something important about systems work: fixing one
layer often reveals problems in the next layer down.</p>
<p>The first bug was a missing feature - straightforward to implement. The second
bug is an architectural design issue that requires careful consideration of how
credential resolution should work when role assumption is involved.</p>
<p>Both bugs are real, both needed fixing, and both will help developers who hit
the same issues. But they required completely different approaches - one needed
code, the other needed a thoughtful design discussion with the maintainers.</p>
<h3 id="status-update">Status Update</h3>
<p>As of this writing, the AWS team is discussing the fix for the credential chain
precedence issue. Our Discourse implementation is ready to go - we're just
waiting on the upstream architectural fix.</p>
<p>Sometimes the best contribution you can make is clearly identifying and
documenting a problem, even when the solution isn't obvious. That's exactly
what happened here.</p>
<h3 id="the-adventure-continues">The Adventure Continues</h3>
<p>Read <a href="/blog/2025/contributing-to-aws-sdk-ruby-pt3/">Part
3</a> to
see how the maintainers responded to the bug report and the workaround I ended
up implementing.</p>


      
        
        

        
          
            
          
            
          
            
          
            
              
                
                  
                
              
                
              
                
                  
                
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
              
                
                  
                
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
                  
                
              
                
              
                
                  
                
              
                
                  
                
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        

        
          <section class="related-posts">
            <h2>Related Posts</h2>
            <ul class="blog-posts">
              
                <li class="post-item">
                  <h3><a href="https:&#x2F;&#x2F;jakegoldsborough.com&#x2F;blog&#x2F;2025&#x2F;contributing-to-aws-sdk-ruby-pt3&#x2F;">AWS SDK Ruby Part 3: When &quot;Working as Intended&quot; Means &quot;Broken by Design&quot;</a></h3>
                  <div class="meta">
                    
                    <p>Oct 14, 2025</p>
                    
                    <p>5 min read</p>
                  </div>
                  
                    <p class="desc">The conclusion to the AWS credential chain saga, where maintainers close a valid bug report, the feature remains broken, and we learn about the politics of backward compatibility in open source.</p>
                  
                  
                    <div class="tags">
                      
                      <p><a href="/tags/aws">#aws</a></p>
                      
                      <p><a href="/tags/ruby">#ruby</a></p>
                      
                      <p><a href="/tags/oss">#oss</a></p>
                      
                    </div>
                  
                  <div class="squiqqle-line"></div>
                </li>
              
                <li class="post-item">
                  <h3><a href="https:&#x2F;&#x2F;jakegoldsborough.com&#x2F;blog&#x2F;2025&#x2F;contributing-to-aws-sdk-ruby&#x2F;">Contributing to the AWS Ruby SDK: When Documentation and Implementation Don&#x27;t Match</a></h3>
                  <div class="meta">
                    
                    <p>Aug 23, 2025</p>
                    
                    <p>4 min read</p>
                  </div>
                  
                    <p class="desc">Discovering and fixing a missing credential source implementation in the AWS Ruby SDK where documentation promised Environment support but the code didn&#x27;t deliver.</p>
                  
                  
                    <div class="tags">
                      
                      <p><a href="/tags/aws">#aws</a></p>
                      
                      <p><a href="/tags/ruby">#ruby</a></p>
                      
                      <p><a href="/tags/oss">#oss</a></p>
                      
                    </div>
                  
                  <div class="squiqqle-line"></div>
                </li>
              
                <li class="post-item">
                  <h3><a href="https:&#x2F;&#x2F;jakegoldsborough.com&#x2F;blog&#x2F;2025&#x2F;yaml-janitor-comment-preservation&#x2F;">Building yaml-janitor: Solving the Comment Preservation Problem</a></h3>
                  <div class="meta">
                    
                    <p>Nov 14, 2025</p>
                    
                    <p>3 min read</p>
                  </div>
                  
                    <p class="desc">How I built a YAML linter that preserves comments, validated 1,736 production files, and published it to RubyGems</p>
                  
                  
                    <div class="tags">
                      
                      <p><a href="/tags/ruby">#ruby</a></p>
                      
                      <p><a href="/tags/yaml">#yaml</a></p>
                      
                      <p><a href="/tags/oss">#oss</a></p>
                      
                      <p><a href="/tags/devops">#devops</a></p>
                      
                    </div>
                  
                  <div class="squiqqle-line"></div>
                </li>
              
                <li class="post-item">
                  <h3><a href="https:&#x2F;&#x2F;jakegoldsborough.com&#x2F;blog&#x2F;2025&#x2F;discourse-invite-stats-evolution&#x2F;">Invite Tree to Invite Stats - How A Simple Tree Flourished Into A Full Moderation Plugin</a></h3>
                  <div class="meta">
                    
                    <p>Nov 05, 2025</p>
                    
                    <p>3 min read</p>
                  </div>
                  
                    <p class="desc">How a simple visualization plugin evolved into a moderation tool.</p>
                  
                  
                    <div class="tags">
                      
                      <p><a href="/tags/discourse">#discourse</a></p>
                      
                      <p><a href="/tags/ruby">#ruby</a></p>
                      
                      <p><a href="/tags/oss">#oss</a></p>
                      
                    </div>
                  
                  <div class="squiqqle-line"></div>
                </li>
              
                <li class="post-item">
                  <h3><a href="https:&#x2F;&#x2F;jakegoldsborough.com&#x2F;blog&#x2F;2025&#x2F;discourse-invite-tree&#x2F;">Visualizing Discourse Invite Trees</a></h3>
                  <div class="meta">
                    
                    <p>Nov 03, 2025</p>
                    
                    <p>2 min read</p>
                  </div>
                  
                    <p class="desc">A simple Discourse plugin that visualizes who invited whom as an ASCII tree, inspired by Lobsters.</p>
                  
                  
                    <div class="tags">
                      
                      <p><a href="/tags/discourse">#discourse</a></p>
                      
                      <p><a href="/tags/ruby">#ruby</a></p>
                      
                      <p><a href="/tags/oss">#oss</a></p>
                      
                    </div>
                  
                  <div class="squiqqle-line"></div>
                </li>
              
            </ul>
          </section>
        
      
    </article>
  

    </main>

    <footer>
      <p><a href="https://jakegoldsborough.com/rss.xml">Subscribe via RSS</a></p>
    </footer>

    <script src="/js/main.js"></script>
    <script data-goatcounter="https://stats.jakegoldsborough.com/count"
        async src="//stats.jakegoldsborough.com/count.js"></script>
  </body>
</html>

