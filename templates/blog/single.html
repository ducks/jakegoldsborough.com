{% extends "base.html" %}

{% block content %}
  <article>
    <h1>{{ page.title }}</h1>
    <div class="meta">
      {% if page.date %}
      <p>{{ page.date | date(format="%b %d, %Y") }}</p>
      {% endif %}
      <p>{{ page.reading_time }} min read</p>
    </div>

    {% if page.taxonomies and page.taxonomies.tags %}
      <p>
        Tags:
        {% for tag in page.taxonomies.tags %}
          <a href="{{ tag.permalink }}">{{ tag.name }}</a>
        {% endfor %}
      </p>
    {% endif %}

    {{ page.content | safe }}

    {% if page.taxonomies.tags %}
      {% set_global related = [] %}
      {% set tags = get_taxonomy(kind="tags") %}

      {% for tag_name in page.taxonomies.tags %}
        {% for tag in tags.items %}
          {% if tag.name == tag_name %}
            {% for tagged_page in tag.pages %}
              {% if tagged_page.permalink != page.permalink %}
                {% set_global related = related | concat(with=tagged_page) %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      {% endfor %}

      {% if related | length > 0 %}
        <section class="related-posts">
          <h2>Related Posts</h2>
          <ul class="blog-posts">
            {% for post in related | slice(end=5) %}
              <li class="post-item">
                <h3><a href="{{ post.permalink }}">{{ post.title }}</a></h3>
                <div class="meta">
                  {% if post.date %}
                  <p>{{ post.date | date(format="%b %d, %Y") }}</p>
                  {% endif %}
                  <p>{{ post.reading_time }} min read</p>
                </div>
                {% if post.description %}
                  <p class="desc">{{ post.description }}</p>
                {% endif %}
                {% if post.taxonomies and post.taxonomies.tags %}
                  <div class="tags">
                    {% for tag in post.taxonomies.tags %}
                    <p><a href="/tags/{{ tag | slugify }}">#{{ tag }}</a></p>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="squiqqle-line"></div>
              </li>
            {% endfor %}
          </ul>
        </section>
      {% endif %}
    {% endif %}
  </article>
{% endblock %}
